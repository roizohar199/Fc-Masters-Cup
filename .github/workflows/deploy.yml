name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # build client
      - name: Install client deps
        working-directory: client
        run: npm ci

      - name: Build client
        working-directory: client
        run: npm run build

      # (אופציונלי) בדיקות שרת/לינטים
      - name: Install server deps
        working-directory: server
        run: npm ci --omit=dev

      # שמירת ארטיפקטים לביצת deploy נקייה
      - name: Pack artifacts
        run: |
          mkdir -p _artifact/client/dist
          mkdir -p _artifact/server
          rsync -a --delete client/dist/ _artifact/client/dist/
          rsync -a --delete server/ _artifact/server/
          # לא מעבירים node_modules של client/server
          rm -rf _artifact/**/node_modules

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fcmasters-artifact
          path: _artifact

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: fcmasters-artifact
          path: _artifact

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # סינכרון בטוח עם rsync: מסנכרנים רק את הארטיפקט, לא את כל ה-Workspace!
      - name: Rsync server
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "mkdir -p /var/www/fcmasters/server /var/www/fcmasters/client/dist"
          rsync -az --delete \
            --exclude 'node_modules' \
            _artifact/server/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/fcmasters/server/
          rsync -az --delete \
            _artifact/client/dist/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/fcmasters/client/dist/

      - name: Restart PM2 on VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          set -euo pipefail
          cd /var/www/fcmasters/server
          # התקנת תלויות שרת ביעד (אם צריך)
          [ -f package-lock.json ] && npm ci --omit=dev || true
          # הפעלה/ריסטארט
          if pm2 describe fcmasters > /dev/null; then
            pm2 restart fcmasters --update-env
          else
            # אם יש build ל-TypeScript – ודא שרץ מקובץ הנכון (dist/index.js)
            pm2 start dist/index.js --name fcmasters || pm2 start index.js --name fcmasters
          fi
          pm2 save
          EOF