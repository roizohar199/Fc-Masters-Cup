name: Deploy

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ---------- CLIENT ----------
      - name: Install client deps
        working-directory: client
        run: npm ci

      - name: Build client
        working-directory: client
        run: npm run build

      # ---------- SERVER ----------
      - name: Install server deps (with dev)
        working-directory: server
        run: npm ci

      - name: Build server (TS -> dist) + verify output
        working-directory: server
        shell: bash
        run: |
          set -euo pipefail
          echo "??  Running server build…"
          npm run build
          echo "?? Listing server/dist:"
          ls -lah dist || true
          if [ ! -f dist/index.js ]; then
            echo "? Build did not produce dist/index.js"
            echo "??  Showing TypeScript output structure:"
            ls -R dist || true
            exit 1
          fi
          echo "? dist/index.js present"
          echo "?? Pruning dev deps for runtime…"
          npm prune --omit=dev

      # ---------- VERSION INFO ----------
      - name: Write version info into server/dist
        shell: bash
        run: |
          mkdir -p server/dist
          {
            echo "commit=$(git rev-parse --short HEAD)"
            echo "built_at=$(date -u +%FT%TZ)"
          } > server/dist/version.txt

      # ---------- PACK ARTIFACTS ----------
      - name: Pack artifacts
        shell: bash
        run: |
          set -euo pipefail
          rm -rf _artifact
          mkdir -p _artifact/client/dist
          mkdir -p _artifact/server/dist

          rsync -a --delete client/dist/ _artifact/client/dist/
          rsync -a server/dist/        _artifact/server/dist/

          cp server/package.json       _artifact/server/package.json
          [ -f server/package-lock.json ] && cp server/package-lock.json _artifact/server/package-lock.json || true

          echo "?? Artifact contents:"
          ls -R _artifact

          if [ ! -f _artifact/server/dist/index.js ]; then
            echo "? Artifact is missing server/dist/index.js"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fcmasters-artifact
          path: _artifact

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: fcmasters-artifact
          path: _artifact

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add host to known_hosts
        shell: bash
        run: |
          set -euo pipefail
          HOST="${{ secrets.VPS_HOST }}"
          PORT="${{ secrets.VPS_PORT }}"
          : "${PORT:=22}"
          mkdir -p ~/.ssh
          ssh-keyscan -p "$PORT" -H "$HOST" >> ~/.ssh/known_hosts

      - name: Test SSH connection
        shell: bash
        run: |
          HOST="${{ secrets.VPS_HOST }}"
          USER="${{ secrets.VPS_USER }}"
          PORT="${{ secrets.VPS_PORT }}"
          : "${PORT:=22}"
          ssh -p "$PORT" "$USER@$HOST" "echo '? SSH OK'; uname -a"

      # ---------- SAFE BACKUP (DB) ----------
      - name: Pre-deploy DB backup (safe & optional)
        shell: bash
        run: |
          HOST="${{ secrets.VPS_HOST }}"
          USER="${{ secrets.VPS_USER }}"
          PORT="${{ secrets.VPS_PORT }}"
          : "${PORT:=22}"
          ssh -p "$PORT" "$USER@$HOST" << 'EOF'
          set -euo pipefail
          DB="/var/www/fcmasters/server/tournaments.sqlite"
          BKDIR="/var/www/fcmasters/server/backups"
          if [ -f "$DB" ]; then
            mkdir -p "$BKDIR"
            if command -v sqlite3 >/dev/null 2>&1; then
              sqlite3 "$DB" "VACUUM INTO '${BKDIR}/tournaments-$(date +%F_%H-%M).sqlite'"
              echo "?? DB backup created in $BKDIR"
            else
              echo "?? sqlite3 not found, skipping backup"
            fi
          else
            echo "?? No DB file at $DB, skipping backup"
          fi
          EOF

      # ---------- RSYNC (SAFE) ----------
      - name: Rsync to server (safe)
        shell: bash
        run: |
          set -euo pipefail
          HOST="${{ secrets.VPS_HOST }}"
          USER="${{ secrets.VPS_USER }}"
          PORT="${{ secrets.VPS_PORT }}"
          : "${PORT:=22}"
          SSH_CMD="ssh -p $PORT"

          $SSH_CMD "$USER@$HOST" "mkdir -p /var/www/fcmasters/client/dist /var/www/fcmasters/server/dist"

          echo "?? Sync client dist…"
          rsync -avz --delete -e "$SSH_CMD" _artifact/client/dist/ "$USER@$HOST:/var/www/fcmasters/client/dist/"

          echo "?? Sync server dist…"
          rsync -avz --delete -e "$SSH_CMD" _artifact/server/dist/ "$USER@$HOST:/var/www/fcmasters/server/dist/"

          echo "?? Update server package files…"
          rsync -avz -e "$SSH_CMD" _artifact/server/package.json "$USER@$HOST:/var/www/fcmasters/server/package.json"
          if [ -f _artifact/server/package-lock.json ]; then
            rsync -avz -e "$SSH_CMD" _artifact/server/package-lock.json "$USER@$HOST:/var/www/fcmasters/server/package-lock.json"
          fi

      # ---------- ENFORCE SUPERADMIN ----------
      - name: Ensure superadmin after deploy
        shell: bash
        run: |
          HOST="${{ secrets.VPS_HOST }}"
          USER="${{ secrets.VPS_USER }}"
          PORT="${{ secrets.VPS_PORT }}"
          ADMIN_EMAIL="${{ secrets.ADMIN_EMAIL }}"
          : "${PORT:=22}"
          ssh -p "$PORT" "$USER@$HOST" << EOF
          set -euo pipefail
          DB='/var/www/fcmasters/server/tournaments.sqlite'
          ADMIN_EMAIL='$ADMIN_EMAIL'
          if [ -f "\$DB" ] && command -v sqlite3 >/dev/null 2>&1; then
            sqlite3 "\$DB" "UPDATE users
              SET role='admin',
                  isSuperAdmin=1,
                  status='active',
                  approvalStatus='approved'
              WHERE email='\$ADMIN_EMAIL';"
            echo "?? ensured superadmin for \$ADMIN_EMAIL"
          else
            echo "?? DB or sqlite3 not found, skipping ensure-superadmin"
          fi
          EOF

      # ---------- INSTALL & PM2 ----------
      - name: Install server deps + restart PM2
        shell: bash
        run: |
          set -euo pipefail
          HOST="${{ secrets.VPS_HOST }}"
          USER="${{ secrets.VPS_USER }}"
          PORT="${{ secrets.VPS_PORT }}"
          : "${PORT:=22}"

          ssh -p "$PORT" "$USER@$HOST" << 'EOF'
          set -euo pipefail
          cd /var/www/fcmasters/server

          echo "?? Installing server dependencies…"
          if [ -f package-lock.json ]; then
            npm ci --omit=dev
          else
            npm install --omit=dev
          fi

          if [ ! -f dist/index.js ]; then
            echo "? ERROR: dist/index.js not found on server (artifact incomplete)."
            echo "??  Contents of dist:"
            ls -lah dist || true
            exit 1
          fi

          if command -v pm2 >/dev/null 2>&1; then
            if pm2 describe fcmasters >/dev/null 2>&1; then
              pm2 reload fcmasters
            else
              pm2 start dist/index.js --name fcmasters
            fi
            pm2 save
            pm2 list
          else
            echo "? PM2 not found. Install with: npm i -g pm2"
            exit 1
          fi
          EOF
