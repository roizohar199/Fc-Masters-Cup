name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json
            client/package-lock.json

      # ××•×¤×¦×™×•× ×œ×™ â€“ ×× ×™×© ×ª×œ×•×ª ×‘×©×•×¨×©
      - name: Install root deps
        if: ${{ hashFiles('package-lock.json') != '' }}
        run: npm ci --no-audit --fund=false

      - name: Install server dependencies
        working-directory: server
        run: |
          if [ -f package-lock.json ]; then
            npm ci --no-audit --fund=false
          else
            npm install --no-audit --fund=false
          fi

      - name: Install client dependencies
        if: ${{ hashFiles('client/package.json') != '' }}
        working-directory: client
        env:
          NPM_CONFIG_OPTIONAL: "true"
        run: |
          if [ -f package-lock.json ]; then
            npm ci --no-audit --fund=false
          else
            npm install --no-audit --fund=false
          fi

      - name: Verify server tree
        working-directory: server
        run: npm ls >/dev/null

      - name: Verify client tree
        if: ${{ hashFiles('client/package.json') != '' }}
        working-directory: client
        run: npm ls >/dev/null

      - name: Build server
        working-directory: server
        run: npm run build

      - name: Build client
        working-directory: client
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            server/dist/
            client/dist/
            package.json
            server/package.json
            server/package-lock.json
            .env.example
          retention-days: 7

  deploy:
    name: Deploy to VPS
    needs: build
    if: ${{ github.ref == 'refs/heads/master' && needs.build.result == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifact

      # ×˜×•×¢×Ÿ ××ª ×”××¤×ª×— ×”×¤×¨×˜×™ ×œ-ssh-agent (×¤×•×ª×¨ Permission denied ×•-libcrypto errors)
      - name: Start ssh-agent and add key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ××•×¡×™×£ ××ª ×”×©×¨×ª ×œ-known_hosts (×œ×œ× ××™× ×˜×¨××§×¦×™×”)
      - name: Add VPS host to known_hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || secrets.VPS_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      # ×“×¤×œ×•×™ ××˜×•××™: ×”×¢×œ××” ×œ×ª×™×§×™×™×ª release ×—×“×©×” ×•×”×—×œ×¤×ª symlink
      - name: Deploy to VPS (rsync + atomic release)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || secrets.VPS_HOST }}
          SSH_USER: ${{ secrets.SSH_USER || secrets.VPS_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/var/www/fcmasters' }}
          RUN: ${{ github.run_number }}
        run: |
          set -e
          
          RELEASE_DIR="${DEPLOY_PATH}/releases/${RUN}"
          
          echo "ğŸš€ Deploying build #${RUN} to ${SSH_USER}@${SSH_HOST}:${RELEASE_DIR}"
          
          # ×™×¦×™×¨×ª ×ª×™×§×™×™×ª release ×‘×©×¨×ª
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "mkdir -p ${RELEASE_DIR}"
          
          # ×”×¢×œ××ª artifacts (server/dist + client/dist)
          echo "ğŸ“¦ Uploading build artifacts..."
          rsync -az -e "ssh -p $SSH_PORT" --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'tournaments.sqlite' \
            ./artifact/ "$SSH_USER@$SSH_HOST:${RELEASE_DIR}/"
          
          echo "âš™ï¸  Running remote deployment commands..."
          
      - name: Install dependencies and switch release
        env:
          SSH_HOST: ${{ secrets.SSH_HOST || secrets.VPS_HOST }}
          SSH_USER: ${{ secrets.SSH_USER || secrets.VPS_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/var/www/fcmasters' }}
          RUN: ${{ github.run_number }}
        run: |
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" bash -lc "
            set -e
            
            APP_DIR='${DEPLOY_PATH}'
            RELEASE_DIR=\"\${APP_DIR}/releases/${RUN}\"
            
            echo 'ğŸ“¦ Installing production dependencies...'
            cd \"\${RELEASE_DIR}/server\"
            npm ci --only=production --no-audit --fund=false
            
            # ×”×¢×ª×§×ª .env ××”×’×¨×¡×” ×”× ×•×›×—×™×ª (×× ×§×™×™××ª)
            if [ -f \"\${APP_DIR}/current/.env\" ]; then
              echo 'ğŸ” Copying .env from current release...'
              cp \"\${APP_DIR}/current/.env\" \"\${RELEASE_DIR}/.env\"
            fi
            
            # ×”×¢×ª×§×ª DB ×§×™×™× (×©××™×¨×ª × ×ª×•× ×™×)
            if [ -f \"\${APP_DIR}/current/tournaments.sqlite\" ]; then
              echo 'ğŸ’¾ Copying database from current release...'
              cp \"\${APP_DIR}/current/tournaments.sqlite\" \"\${RELEASE_DIR}/tournaments.sqlite\"
            fi
            
            # ×”×—×œ×¤×ª symlink ××˜×•××™×ª
            echo 'ğŸ”„ Switching to new release...'
            ln -sfn \"\${RELEASE_DIR}\" \"\${APP_DIR}/current\"
            
            # ×˜×¢×™× ×” ××—×“×© ×©×œ ×”×©×™×¨×•×ª (graceful reload)
            echo 'â™»ï¸  Reloading application...'
            if command -v pm2 >/dev/null 2>&1; then
              pm2 reload fcmasters || pm2 start \"\${APP_DIR}/current/server/dist/index.js\" --name fcmasters
            elif command -v systemctl >/dev/null 2>&1; then
              sudo systemctl reload fcmasters || sudo systemctl restart fcmasters
            else
              echo 'âš ï¸  Warning: No process manager found (pm2/systemd). Manual restart needed.'
            fi
            
            # × ×™×§×•×™ ×’×¨×¡××•×ª ×™×©× ×•×ª (×©××™×¨×ª 5 ××—×¨×•× ×•×ª)
            echo 'ğŸ§¹ Cleaning up old releases...'
            cd \"\${APP_DIR}/releases\"
            ls -t | tail -n +6 | xargs -r rm -rf
            
            echo 'âœ… Deployment completed successfully!'
          "
