name: Deploy to Hostinger VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # ××¤×©×¨×•×ª ×œ×”×¤×¢×œ×” ×™×“× ×™×ª ×-GitHub UI

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ğŸ“¦ Install root dependencies
      run: |
        if [ -f package.json ]; then
          npm ci || npm install
        else
          echo "No root package.json found, skipping..."
        fi
    
    - name: ğŸ“¦ Install server dependencies
      run: |
        cd server
        npm ci || npm install
    
    - name: ğŸ“¦ Install client dependencies
      run: |
        cd client
        npm ci || npm install
    
    - name: ğŸ”¨ Build server
      run: |
        cd server
        npm run build
    
    - name: ğŸ”¨ Build client
      run: |
        cd client
        npm run build
    
    - name: ğŸ“‹ Prepare deployment files
      run: |
        echo "Creating deployment package..."
        mkdir -p deploy_temp
        
        # Copy built files
        cp -r server/dist deploy_temp/server_dist
        cp -r client/dist deploy_temp/client_dist
        
        # Copy package files for production install
        cp server/package.json deploy_temp/server_package.json
        cp server/package-lock.json deploy_temp/server_package-lock.json
        
        echo "âœ… Deployment package ready"
    
    - name: ğŸš€ Deploy to VPS - Server dist
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        source: "deploy_temp/server_dist/*"
        target: "/var/www/fcmasters/server/"
        strip_components: 2
        rm: false
    
    - name: ğŸš€ Deploy to VPS - Client dist
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        source: "deploy_temp/client_dist/*"
        target: "/var/www/fcmasters/client/"
        strip_components: 2
        rm: false
    
    - name: ğŸš€ Deploy to VPS - Package files
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        source: "deploy_temp/server_package.json,deploy_temp/server_package-lock.json"
        target: "/var/www/fcmasters/server/"
        strip_components: 1
        rm: false
    
    - name: ğŸ”„ Install dependencies and restart server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          cd /var/www/fcmasters/server
          
          # Rename package files
          mv server_package.json package.json 2>/dev/null || true
          mv server_package-lock.json package-lock.json 2>/dev/null || true
          
          # Install production dependencies
          echo "ğŸ“¦ Installing production dependencies..."
          npm install --production
          
          # Restart PM2
          echo "ğŸ”„ Restarting application..."
          pm2 restart fc-masters || pm2 start dist/index.js --name fc-masters
          pm2 save
          
          echo "âœ… Deployment completed successfully!"
          pm2 status
    
    - name: ğŸ‰ Deployment Summary
      if: success()
      run: |
        echo "âœ… Deployment completed successfully!"
        echo "ğŸŒ Your site should be live at your configured domain"
        echo "ğŸ“Š Check PM2 status on your VPS with: pm2 status"
    
    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "Please check the logs above for errors"
        echo "You can also SSH to your VPS and check: pm2 logs fc-masters"

