# תיקון בעיות שכחתי סיסמה 🔑

## סיכום הבעיות שמצאתי

### ✅ בעיה 1: Rate Limiter מחמיר מדי
**הבעיה:** המערכת הגבילה ל-3 ניסיונות בלבד תוך 15 דקות, מה שגרם ל-429 "Too Many Requests"

**הפתרון שיישמתי:**
- הגדלתי את המספר ל-5 ניסיונות
- הקטנתי את הזמן ל-10 דקות
- הוספתי חסימה לפי email+IP (במקום רק IP)

```typescript
const emailLimiter = rateLimit({ 
  windowMs: 10 * 60 * 1000, // 10 דקות
  max: 5, // מקסימום 5 ניסיונות ב-10 דקות
  keyGenerator: (req) => {
    const email = req.body?.email || '';
    return `${req.ip}-${email}`;
  }
});
```

---

### ✅ בעיה 2: אי עקביות במשתני סביבה
**הבעיה:** חלק מהפונקציות השתמשו ב-`EMAIL_FROM` וחלק ב-`SMTP_FROM`

**הפתרון שיישמתי:**
- איחדתי את כל הפונקציות להשתמש ב-`SMTP_FROM`
- תיקנתי 4 פונקציות ב-`server/src/email.ts`

---

### ⚠️ בעיה 3: SMTP_PASS עם רווחים (דורש תיקון ידני!)
**הבעיה הקריטית:** בקובץ `.env` שלך:
```
SMTP_PASS=qxbz iexp hbks mmtn
```

**Gmail App Password** מוצג עם רווחים, אבל **nodemailer צריך אותו בלי רווחים!**

**איך לתקן:**
1. פתח את הקובץ `.env`
2. מצא את השורה:
   ```
   SMTP_PASS=qxbz iexp hbks mmtn
   ```
3. הסר את כל הרווחים:
   ```
   SMTP_PASS=qxbziexphbksmmtn
   ```
4. שמור את הקובץ
5. אתחל את השרת מחדש

---

### ✅ בעיה 4: הקוד נבנה והושק מחדש
השרת כבר רץ עם התיקונים החדשים.

---

## איך לבדוק שהכל עובד

### 1. תקן את ה-SMTP_PASS (ראה למעלה)

### 2. אתחל את השרת:
```powershell
cd server
taskkill /F /IM node.exe
npm run build
npm start
```

### 3. בדוק שליחת מייל:
```powershell
.\test-forgot-simple.ps1
```

אם הכל עובד, תראה:
```
Success!
Response:
{
    "ok":  true,
    "message":  "אם האימייל קיים במערכת, נשלח אליך קישור לאיפוס סיסמה"
}
```

**ותקבל מייל** עם קישור לאיפוס הסיסמה!

---

## בדיקת לוגים
אם עדיין יש בעיה, בדוק את לוגי השרת:
- הם יכתבו `[email] ✅ Password reset email sent to: ...` אם המייל נשלח
- או `[email] ❌ Failed to send email to ...` אם יש שגיאה

---

## בעיות נוספות אפשריות

### אם המייל עדיין לא מגיע:
1. בדוק את תיקיית הספאם
2. וודא ש-Gmail App Password תקף (יצרת אותו ב-https://myaccount.google.com/apppasswords)
3. וודא שהפעלת 2FA בחשבון Google
4. בדוק שהמייל `fcmasters9@gmail.com` מאושר לשלוח מיילים

### אם יש שגיאת SMTP:
- וודא שה-SMTP_PORT הוא 587 (לא 465)
- וודא ש-SMTP_HOST הוא `smtp.gmail.com`

---

## מה שינתי בקוד:
1. ✅ `server/src/routes/auth.ts` - rate limiter משופר
2. ✅ `server/src/email.ts` - תיקון משתני סביבה
3. ⚠️ `.env` - **אתה צריך לתקן ידנית את SMTP_PASS**

---

## הערות חשובות
- השרת כבר נבנה ורץ עם התיקונים
- רק צריך לתקן את ה-`SMTP_PASS` ב-`.env`
- אחרי התיקון - אתחל את השרת
- אז תוכל לבדוק שוב עם `.\test-forgot-simple.ps1`

בהצלחה! 🚀

