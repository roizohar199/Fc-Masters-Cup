# 🖥️ הוראות לביצוע בשרת - k-rstudio.com

## 📋 סיכום
אחרי שדחפת את כל השינויים ל-Git, תצטרך לבצע **פעולות אלו בשרת** כדי לתקן את בעיית WebSocket.

---

## 🚀 שלב 1: משוך את השינויים מ-Git

התחבר לשרת ומשוך את העדכונים:

```bash
# התחבר לשרת
ssh root@k-rstudio.com

# נווט לתיקיית הפרויקט
cd /var/www/fcmasters

# משוך את השינויים מ-Git
git pull origin master

# התקן תלויות (אם יש עדכונים)
cd server
npm install
cd ../client
npm install
cd ..
```

---

## 🔒 שלב 2: התקן SSL Certificate (אם עדיין לא קיים)

בדוק אם יש לך SSL Certificate:

```bash
sudo ls -la /etc/letsencrypt/live/k-rstudio.com/
```

**אם אין** (או יש שגיאה), התקן Let's Encrypt:

```bash
# התקן Certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx -y

# יצירת SSL certificate
sudo certbot --nginx -d k-rstudio.com -d www.k-rstudio.com
```

Certbot ישאל אותך מספר שאלות:
1. **Email**: הכנס email תקף לקבלת התראות
2. **Terms of Service**: הקלד `Y` (הסכמה)
3. **Share email**: `N` (לא חובה)
4. **Redirect HTTP to HTTPS**: הקלד `2` (Yes - מומלץ!)

---

## 🔧 שלב 3: עדכן את תצורת Nginx

### אופציה א': העתקה ידנית (מומלצת)

```bash
# גיבוי התצורה הנוכחית
sudo cp /etc/nginx/sites-available/fcmasters /etc/nginx/sites-available/fcmasters.backup-$(date +%Y%m%d-%H%M%S)

# ערוך את התצורה
sudo nano /etc/nginx/sites-available/fcmasters
```

**במסך הנאנו:**
1. מחק את **כל התוכן** הישן (Ctrl+K כמה פעמים)
2. העתק את התוכן מהקובץ `nginx-config-k-rstudio-ssl.txt` (בפרויקט המקומי)
3. הדבק (Ctrl+Shift+V או לחצן ימני)
4. שמור (Ctrl+O, Enter, Ctrl+X)

### אופציה ב': העתקה מהמחשב המקומי

אם יש לך את הקובץ במחשב המקומי:

```bash
# מהמחשב המקומי שלך (Windows PowerShell):
scp "C:\FC Masters Cup\nginx-config-k-rstudio-ssl.txt" root@k-rstudio.com:/tmp/nginx-new-config.txt

# בשרת:
sudo cp /tmp/nginx-new-config.txt /etc/nginx/sites-available/fcmasters
```

### בדיקה וטעינה מחדש:

```bash
# בדוק את התצורה
sudo nginx -t

# אם הכל תקין - טען מחדש
sudo systemctl reload nginx

# בדוק סטטוס
sudo systemctl status nginx
```

---

## 📝 שלב 4: עדכן את קובץ .env בשרת

וודא שהערכים נכונים:

```bash
# ערוך את .env בשרת
nano /var/www/fcmasters/server/.env
```

**וודא שיש:**
```env
# ערכים אלו **חייבים** להיות נכונים!
CORS_ORIGIN=https://www.k-rstudio.com
SITE_URL=https://www.k-rstudio.com
NODE_ENV=production
PORT=8787
```

שמור (Ctrl+O, Enter, Ctrl+X)

---

## 🔄 שלב 5: בנה מחדש ו-Restart

```bash
# בנה את הקוד
cd /var/www/fcmasters

# בנה Client
cd client
npm run build

# בנה Server
cd ../server
npm run build

# Restart השרת
pm2 restart fc-masters

# בדוק סטטוס
pm2 status
pm2 logs fc-masters --lines 20
```

---

## ✅ שלב 6: בדיקה שהכל עובד

### בדיקה 1: בדוק לוגים

```bash
# לוגי PM2
pm2 logs fc-masters --lines 50

# לוגי Nginx
sudo tail -f /var/log/nginx/error.log
```

חפש:
- ✅ `Server started successfully on http://localhost:8787`
- ✅ `Presence WebSocket attached to /presence`
- ❌ **אין שגיאות** של SSL או WebSocket

### בדיקה 2: בדוק Ports

```bash
# וודא שהשרת מאזין
sudo netstat -tlnp | grep 8787

# וודא ש-Nginx מאזין על 443
sudo netstat -tlnp | grep 443
```

### בדיקה 3: בדיקה בדפדפן

פתח: `https://www.k-rstudio.com`

1. פתח **Console** (F12)
2. חפש את ההודעות:
   ```
   🔌 Connecting to WebSocket: wss://www.k-rstudio.com/presence
   ✅ WebSocket connected successfully
   👋 Presence hello: X users
   ```

אם אתה רואה את זה - **מזל טוב!** הכל עובד! 🎉

---

## ❌ פתרון בעיות

### בעיה: SSL Certificate לא נמצא

**שגיאה:**
```
nginx: [emerg] cannot load certificate
```

**פתרון:**
```bash
sudo certbot --nginx -d k-rstudio.com -d www.k-rstudio.com
sudo systemctl reload nginx
```

---

### בעיה: WebSocket עדיין נכשל (1006)

**בדיקה:**
```bash
# בדוק שהשרת רץ
pm2 status

# בדוק לוגים
pm2 logs fc-masters --lines 50

# בדוק Nginx
sudo tail -f /var/log/nginx/error.log
```

**פתרון:**
```bash
# Restart הכל
pm2 restart fc-masters
sudo systemctl reload nginx
```

---

### בעיה: Port 443 תפוס

**שגיאה:**
```
bind() to 0.0.0.0:443 failed (98: Address already in use)
```

**פתרון:**
```bash
# בדוק מי תופס את Port 443
sudo lsof -i :443

# אם יש Apache או שרת אחר, עצור אותו
sudo systemctl stop apache2

# טען מחדש Nginx
sudo systemctl reload nginx
```

---

### בעיה: CORS Error

**שגיאה בדפדפן:**
```
Access to XMLHttpRequest blocked by CORS policy
```

**פתרון:**
```bash
# ודא שב-.env יש:
nano /var/www/fcmasters/server/.env

# וודא:
CORS_ORIGIN=https://www.k-rstudio.com

# Restart
pm2 restart fc-masters
```

---

## 📊 Check List - לביצוע בשרת

- [ ] משכתי את השינויים מ-Git (`git pull`)
- [ ] SSL Certificate מותקן (Certbot)
- [ ] תצורת Nginx עודכנה עם SSL + WebSocket
- [ ] `nginx -t` עובר ללא שגיאות
- [ ] Nginx נטען מחדש (`systemctl reload nginx`)
- [ ] `.env` עודכן עם CORS_ORIGIN נכון
- [ ] Client נבנה מחדש (`npm run build`)
- [ ] Server נבנה מחדש (`npm run build`)
- [ ] PM2 עשה restart (`pm2 restart fc-masters`)
- [ ] הדפדפן מציג "✅ WebSocket connected successfully"
- [ ] אין שגיאות בלוגים

---

## 🎉 סיכום

אחרי ביצוע כל השלבים:
1. ✅ האתר רץ על HTTPS מאובטח
2. ✅ WebSocket עובד דרך WSS
3. ✅ מערכת הנוכחות עובדת בזמן אמת
4. ✅ כל התעבורה מועברת אוטומטית ל-HTTPS

---

## 🆘 עדיין לא עובד?

1. **אסוף לוגים:**
   ```bash
   pm2 logs fc-masters --lines 100 > ~/server-logs.txt
   sudo tail -n 100 /var/log/nginx/error.log > ~/nginx-error.txt
   sudo nginx -T > ~/nginx-config.txt
   ```

2. **הורד את הלוגים למחשב המקומי:**
   ```bash
   scp root@k-rstudio.com:~/server-logs.txt .
   scp root@k-rstudio.com:~/nginx-error.txt .
   scp root@k-rstudio.com:~/nginx-config.txt .
   ```

3. **בדוק את הלוגים** ותזהה את הבעיה

---

**בהצלחה!** 🚀

