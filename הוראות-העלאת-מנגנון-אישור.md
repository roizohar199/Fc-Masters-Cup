# הוראות העלאה - מנגנון אישור מנהל למשתמשים

## 📋 קבצים שצריך להעלות

### שלב 1️⃣: בנייה מקומית (Local Build)

#### בנה את השרת:
```bash
cd server
npm run build
```

#### בנה את הלקוח:
```bash
cd client
npm run build
```

---

### שלב 2️⃣: העלאת קבצים לשרת

#### A. **קבצי שרת (Server):**

העלה את הקבצים הבאים:

```
server/
├── dist/
│   ├── routes/
│   │   └── approvalRequests.js      ⭐ חדש
│   ├── db.js                         ⭐ מעודכן
│   └── index.js                      ⭐ מעודכן
├── package.json
└── tournaments.sqlite                ⭐ מסד נתונים מעודכן
```

#### B. **קבצי לקוח (Client):**

העלה את **כל** תיקיית `client/dist/`:

```
client/
└── dist/
    ├── index.html
    └── assets/
        └── (כל הקבצים)
```

---

### שלב 3️⃣: וידוא שמסד הנתונים מעודכן

הטבלה `approval_requests` תיווצר אוטומטית כשהשרת יעלה.

העמודות הבאות ב-`users` יתווספו אוטומטית אם הן לא קיימות:
- `isSuperAdmin` (INTEGER)
- `approvalStatus` (TEXT)
- `approvalToken` (TEXT)

---

### שלב 4️⃣: הפעלה מחדש של השרת

```bash
cd server
pm2 restart fc-masters-cup
# או
npm start
```

---

## ✅ בדיקת תקינות

### בדוק שה-API עובד:

```bash
# בדוק בקשות אישור ממתינות (דורש מנהל על)
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://your-domain.com/api/approval-requests/pending

# בדוק ספירת בקשות
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://your-domain.com/api/approval-requests/count
```

### בדוק בממשק האדמין:

1. התחבר כמנהל על
2. היכנס ל-Admin Dashboard
3. אמור לראות חלון "בקשות ממתינות" (אם `isSuperAdmin=1`)

---

## 🔑 הגדרת מנהל על

ודא שקובץ `.env` בשרת מכיל:

```env
ADMIN_EMAIL=your-email@example.com
ADMIN_PASSWORD=your-secure-password
```

השרת יגדיר אוטומטית את המשתמש הזה כ-Super Admin עם `isSuperAdmin=1`.

---

## 📂 רשימת קבצים מלאה להעלאה

### שרת (קבצים מקומפלים):
- ✅ `server/dist/routes/approvalRequests.js`
- ✅ `server/dist/db.js`
- ✅ `server/dist/index.js`
- ✅ `server/dist/auth.js` (אם עודכן)
- ✅ `server/tournaments.sqlite`

### לקוח (כל dist):
- ✅ `client/dist/` (כל התיקייה)

---

## 🛠️ פתרון בעיות

### אם לא רואה בקשות אישור:

1. בדוק שהמשתמש הוא Super Admin:
   ```sql
   SELECT email, isSuperAdmin FROM users WHERE email='your-email@example.com';
   ```

2. בדוק שהטבלה קיימת:
   ```sql
   SELECT * FROM approval_requests;
   ```

3. בדוק לוגים של השרת:
   ```bash
   pm2 logs fc-masters-cup
   ```

### אם יש שגיאות:

1. ודא ש-`node_modules` מעודכן בשרת
2. הרץ `npm install` בתיקיית `server/`
3. הפעל מחדש את השרת

---

## 📝 הערות חשובות

- מנהל **רגיל** יוצר בקשות אישור שמנהל **על** צריך לאשר
- מנהל **על** (`isSuperAdmin=1`) יכול לבצע פעולות ישירות ללא אישור
- הפעולות הנתמכות:
  - `block` - חסימת משתמש
  - `unblock` - ביטול חסימה
  - `reset-password` - איפוס סיסמה
  - `update-credit` - עדכון זיכוי
  - `promote` - הפיכה למנהל
  - `demote` - הורדה לשחקן
  - `delete` - מחיקת משתמש

---

סיימת! המנגנון אמור לעבוד באתר החי 🎉

