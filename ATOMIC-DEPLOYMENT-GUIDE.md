# ğŸš€ ××“×¨×™×š ×“×¤×œ×•×™ ××˜×•××™ - GitHub Actions

## ×¡×§×™×¨×” ×›×œ×œ×™×ª

×”-workflow ×¢×•×“×›×Ÿ ×œ×ª××•×š ×‘×“×¤×œ×•×™ ××˜×•××™ ×¢× ×”×¤×¨×“×” ××œ××” ×‘×™×Ÿ Build ×•-Deploy.

## ğŸ—ï¸ ××‘× ×” ×”-Workflow

### Job 1: Build
- âœ… ×”×ª×§× ×ª ×ª×œ×•×™×•×ª (root, server, client)
- âœ… ×‘× ×™×™×ª ×”×§×•×“ (TypeScript â†’ JavaScript)
- âœ… ××™××•×ª ×ª×§×™× ×•×ª (`npm ls`)
- âœ… ×©××™×¨×ª artifacts ×œ×©×™××•×© ×‘-deploy

### Job 2: Deploy
- â³ ××ª×‘×¦×¢ **×¨×§ ××** Build ×”×¦×œ×™×—
- â³ ××ª×‘×¦×¢ **×¨×§ ×¢×œ** branch `master`
- ğŸ” ××©×ª××© ×‘-secrets: `SSH_PRIVATE_KEY`, `VPS_HOST`, `VPS_USER`

## ğŸ¯ ×“×¤×œ×•×™ ××˜×•××™ (Zero-Downtime)

### ××‘× ×” ×”×ª×™×§×™×•×ª ×‘×©×¨×ª

```
/var/www/fcmasters/
â”œâ”€â”€ current/          â†’ symlink ×œ×’×¨×¡×” ×”×¤×¢×™×œ×”
â”œâ”€â”€ releases/
â”‚   â”œâ”€â”€ 1234/        (×’×¨×¡×” ×™×©× ×”)
â”‚   â”œâ”€â”€ 1235/        (×’×¨×¡×” ×™×©× ×”)
â”‚   â””â”€â”€ 1236/        â† current ××¦×‘×™×¢ ×›××Ÿ
â””â”€â”€ shared/          (××•×¤×¦×™×•× ×œ×™ - ×œ×§×‘×¦×™× ××©×•×ª×¤×™×)
```

### ×ª×”×œ×™×š ×”×“×¤×œ×•×™

1. **×™×¦×™×¨×ª release ×—×“×©** - `releases/{run_number}/`
2. **×”×¢×œ××ª ×§×‘×¦×™×** - rsync ×œ×ª×™×§×™×™×ª ×”-release ×”×—×“×©×”
3. **×”×ª×§× ×ª ×ª×œ×•×™×•×ª** - npm ci ×‘×ª×™×§×™×™×ª ×”-release (×œ× ×‘-current!)
4. **×”×¢×ª×§×ª ×§×‘×¦×™× ×§×¨×™×˜×™×™×**:
   - `.env` (×”×’×“×¨×•×ª)
   - `tournaments.sqlite` (××¡×“ × ×ª×•× ×™×)
5. **×”×—×œ×¤×” ××˜×•××™×ª** - `ln -sfn` ××©× ×” symlink ×‘-×¤×¢×•×œ×” ××—×ª
6. **×˜×¢×™× ×” ××—×“×©** - PM2/systemd reload/restart
7. **× ×™×§×•×™** - ××—×™×§×ª releases ×™×©× ×™× (×©×•××¨ 5 ××—×¨×•× ×™×)

## ğŸ”§ ×”×’×“×¨×•×ª × ×“×¨×©×•×ª ×‘-GitHub Secrets

×¢×‘×•×¨ ×œ-Settings â†’ Secrets and variables â†’ Actions:

```bash
SSH_PRIVATE_KEY   # ××¤×ª×— SSH ×¤×¨×˜×™ (id_rsa)
VPS_HOST          # ×›×ª×•×‘×ª ×”×©×¨×ª (example.com ××• IP)
VPS_USER          # ×©× ××©×ª××© SSH (root ××• ××—×¨)
```

## ğŸ“¦ ×§×‘×¦×™× ×©× ×©××¨×™× ×‘×™×Ÿ ×’×¨×¡××•×ª

- `.env` - ××©×ª× ×™× ×¡×‘×™×‘×”
- `tournaments.sqlite` - ××¡×“ ×”× ×ª×•× ×™×

×§×‘×¦×™× ××œ×• **×œ× ××•×—×œ×¤×™×** ×‘×“×¤×œ×•×™ - ×”× ××•×¢×ª×§×™× ××”-current ×”×§×™×™×.

## âš™ï¸ × ×™×”×•×œ ×©×™×¨×•×ª

×”-workflow ××–×”×” ××•×˜×•××˜×™×ª ××ª ×× ×”×œ ×”×ª×”×œ×™×›×™×:

### PM2 (××•××œ×¥)
```bash
pm2 reload fcmasters     # ×˜×¢×™× ×” ×—×œ×§×”
pm2 restart fcmasters    # ×× reload × ×›×©×œ
```

### systemd
```bash
sudo systemctl reload fcmasters    # ×˜×¢×™× ×” ×—×œ×§×”
sudo systemctl restart fcmasters   # ×× reload × ×›×©×œ
```

## ğŸ”„ ×©×—×–×•×¨ ×’×¨×¡×” (Rollback)

×× ×™×© ×‘×¢×™×” ×¢× ×’×¨×¡×” ×—×“×©×”:

```bash
ssh user@host
cd /var/www/fcmasters
ln -sfn releases/1235 current    # ×—×–×¨×” ×œ×’×¨×¡×” ×§×•×“××ª
pm2 reload fcmasters              # ××• systemctl reload
```

## ğŸ› ï¸ ×©×™× ×•×™×™× ×©×‘×•×¦×¢×•

### ×‘-`.github/workflows/deploy.yml`:

1. âœ… ×”×•×¡×¤×ª `NPM_CONFIG_OPTIONAL: "true"` ×œ×”×ª×§× ×ª client
2. âœ… ×”×¤×¨×“×ª build ×•-deploy ×œ×©× ×™ jobs × ×¤×¨×“×™×
3. âœ… ×”×¢×œ××ª artifacts ××—×¨×™ build
4. âœ… ×ª× ××™ ×”×¨×¦×ª deploy: `needs.build.result == 'success'`
5. âœ… ×“×¤×œ×•×™ ××˜×•××™ ×¢× releases directory
6. âœ… × ×™×§×•×™ ××•×˜×•××˜×™ ×©×œ releases ×™×©× ×™×

### ×™×ª×¨×•× ×•×ª:

- ğŸš€ **Zero downtime** - ××™×Ÿ ×”×¤×¨×¢×” ×œ××©×ª××©×™×
- ğŸ”„ **Rollback ××”×™×¨** - × ×™×ª×Ÿ ×œ×—×–×•×¨ ×‘×§×œ×•×ª
- ğŸ›¡ï¸ **×‘×˜×•×—** - ×”×ª×§× ×ª ×ª×œ×•×™×•×ª ×œ× ××©×‘×©×ª ××ª ×”××ª×¨ ×”×—×™
- ğŸ“Š **× ×™×”×•×œ ×’×¨×¡××•×ª** - ×©××™×¨×ª 5 ×’×¨×¡××•×ª ××—×¨×•× ×•×ª
- âš¡ **Build ××•×¤×¨×“** - ×©×’×™××ª build ×œ× ××©×¤×™×¢×” ×¢×œ production

## ğŸ“ ×”×¢×¨×•×ª

- ×”-workflow **×œ×** ×™×¨×•×¥ ×× ×”-build × ×›×©×œ
- ×”×ª×œ×•×™×•×ª ××•×ª×§× ×•×ª **×‘×ª×™×§×™×™×ª release ×‘×œ×‘×“**, ×œ× ×‘-current
- ×”-symlink `current` ××©×ª× ×” **×‘×¤×¢×•×œ×” ××˜×•××™×ª ××—×ª**
- ××¡×“ ×”× ×ª×•× ×™× × ×©××¨ ×ª××™×“ (×œ× ××•×—×œ×£)

## ğŸ§ª ×‘×“×™×§×”

×œ×‘×“×•×§ ××ª ×”××‘× ×” ×‘×©×¨×ª:

```bash
ssh user@host
cd /var/www/fcmasters
ls -la current          # ×¦×¨×™×š ×œ×”×™×•×ª symlink
ls -la releases/        # ×¨×©×™××ª ×›×œ ×”-releases
readlink current        # ××™×–×• ×’×¨×¡×” ×¤×¢×™×œ×” ×›×¨×’×¢
```

---

âœ¨ **×”×“×¤×œ×•×™ ×”×—×“×© ××‘×˜×™×— ×××™× ×•×ª ×’×‘×•×”×” ×•×–××Ÿ ×”×©×‘×ª×” ××¤×¡×™!**

