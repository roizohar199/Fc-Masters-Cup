# âœ… ××¢×¨×›×ª ××‘×—×•×Ÿ ××™×™×œ×™× - ×”×•×©×œ××” ×‘×”×¦×œ×—×”!

## ğŸ“‹ ××” × ×•×¡×£ ×œ××¢×¨×›×ª?

### 1. ğŸ” ××‘×—×•×Ÿ SMTP ××•×˜×•××˜×™
- **×‘×¢×ª ×¢×œ×™×™×ª ×”×©×¨×ª**: ×‘×“×™×§×” ××•×˜×•××˜×™×ª ×©×œ ×—×™×‘×•×¨ SMTP
- **×œ×•×’×™× ×‘×¨×•×¨×™×**: `âœ… SMTP verify OK` ××• `âŒ SMTP verify FAILED` ×¢× ×¡×™×‘×” ××“×•×™×§×ª
- **×”×¦×’×ª ×”×’×“×¨×•×ª**: ×›×œ ×¤×¨×˜×™ ×”-SMTP ××•×“×¤×¡×™× ×‘×¢×œ×™×™×”

### 2. ğŸ“Š ×œ×•×’ ××œ× ×©×œ ×›×œ ××™×™×œ
- **×˜×‘×œ×ª DB ×—×“×©×”**: `email_logs` ×©×©×•××¨×ª ×›×œ × ×™×¡×™×•×Ÿ ×©×œ×™×—×”
- **××” × ×©××¨**:
  - ×›×ª×•×‘×ª × ××¢×Ÿ
  - × ×•×©× ×”××™×™×œ
  - ×¡×˜×˜×•×¡ (SENT/ERROR)
  - ×”×•×“×¢×ª ×©×’×™××”
  - Message ID
  - ×–××Ÿ ×©×œ×™×—×”
- **×©×™××•×¨ ×”×™×¡×˜×•×¨×™×”**: ×›×œ ×”××™×™×œ×™× × ×©××¨×™× ×œ×œ× ××’×‘×œ×”

### 3. âš ï¸ ××–×”×¨×•×ª ××•×˜×•××˜×™×•×ª
- ××–×”×¨×” ×× `ADMIN_EMAILS` ×¨×™×§
- ××–×”×¨×” ×× `SMTP_USER` ××• `SMTP_PASS` ×—×¡×¨×™×
- ×”×¦×’×ª ×›×ª×•×‘×•×ª ×× ×”×œ×™× ×‘×¢×ª ×¢×œ×™×™×”

### 4. ğŸ› ï¸ ×›×œ×™ ××‘×—×•×Ÿ ××•×‘× ×™×

#### API Endpoints (×× ×”×œ×™× ×‘×œ×‘×“):

##### `/api/admin/smtp/verify` - ×‘×“×™×§×ª ×—×™×‘×•×¨
```bash
curl https://k-rstudio.com/api/admin/smtp/verify \
  -H "Cookie: session=YOUR_SESSION"
```
**×ª×’×•×‘×”:**
```json
{
  "ok": true,
  "host": "smtp.gmail.com",
  "port": 587,
  "secure": false,
  "from": "fcmasters9@gmail.com",
  "user": "fcmasters9@gmail.com"
}
```

##### `/api/admin/smtp/test` - ×©×œ×™×—×ª ×˜×¡×˜
```bash
curl -X POST https://k-rstudio.com/api/admin/smtp/test \
  -H "Content-Type: application/json" \
  -H "Cookie: session=YOUR_SESSION" \
  -d '{"to":"fcmasters9@gmail.com"}'
```
**×ª×’×•×‘×”:**
```json
{
  "ok": true,
  "messageId": "<abc123@gmail.com>"
}
```

##### `/api/admin/smtp/email-logs` - ×¦×¤×™×™×” ×‘×œ×•×’×™×
```bash
curl https://k-rstudio.com/api/admin/smtp/email-logs \
  -H "Cookie: session=YOUR_SESSION"
```
**×ª×’×•×‘×”:**
```json
{
  "items": [
    {
      "id": 1,
      "to_email": "fcmasters9@gmail.com",
      "subject": "ğŸ†• ××©×ª××© ×—×“×© × ×¨×©×",
      "status": "SENT",
      "error": null,
      "created_at": "2025-10-21 10:30:00"
    }
  ]
}
```

### 5. ğŸ“ ×œ×•×’×™× ××¤×•×¨×˜×™× ×‘× ×§×•×“×•×ª ×§×¨×™×˜×™×•×ª

#### ×”×¨×©××ª ××©×ª××© ×—×“×©:
```
ğŸ“§ ADMIN_EMAIL from ENV: fcmasters9@gmail.com
ğŸ“§ Sending admin approval request to: fcmasters9@gmail.com
âœ… Admin approval request sent successfully
ğŸ“§ Sending admin notification to: fcmasters9@gmail.com
âœ… Admin notification sent successfully
```

#### ×”×¦×˜×¨×¤×•×ª ×œ×˜×•×¨× ×™×¨:
```
ğŸ“§ ADMIN notify: user joined tournament -> user@example.com T: tournament-123
ğŸ“§ Sending to 1 admin(s): × ×¨×©× ×—×“×© ×œ×˜×•×¨× ×™×¨
âœ… Tournament registration email sent successfully
```

---

## ğŸ“¦ ×§×‘×¦×™× ×©× ×•×¦×¨×•

### ×§×‘×¦×™ ×ª×™×¢×•×“:
1. **`EMAIL-DIAGNOSTICS-GUIDE.md`** â­ - **××“×¨×™×š ××¤×•×¨×˜ ×¢× ×›×œ ×”×ª×©×•×‘×•×ª**
2. **`EMAIL-DIAGNOSTICS-SUMMARY.md`** - ×¡×™×›×•× ××”×™×¨
3. **`EMAIL-DIAGNOSTICS-COMPLETE.md`** (×–×”) - ×¡×™×›×•× ×”××™××•×©

### ×¡×§×¨×™×¤×˜×™×:
4. **`test-email-system.mjs`** - ×‘×“×™×§×” ××§×•××™×ª (`npm run test:email`)
5. **`check-email-on-server.sh`** - ×‘×“×™×§×” ×‘×©×¨×ª (SSH)
6. **`test-email-remote.ps1`** - ×‘×“×™×§×” ××¨×—×•×§ (PowerShell)

### ×§×•×“:
7. **`server/src/modules/mail/mailer.ts`** - ××•×“×•×œ SMTP ××©×•×“×¨×’
8. **`server/src/modules/admin/smtp.routes.ts`** - ×¨××•×˜×™ ××‘×—×•×Ÿ
9. **`server/src/index.ts`** - ××™××•×ª ×‘×¢×ª ×¢×œ×™×™×”
10. **`server/src/routes/auth.ts`** - ×œ×•×’×™× ×‘×”×¨×©××”
11. **`server/src/routes/tournamentRegistrations.ts`** - ×œ×•×’×™× ×‘×”×¦×˜×¨×¤×•×ª

### ×§×•× ×¤×™×’×•×¨×¦×™×”:
12. **`env.example`** - ××¢×•×“×›×Ÿ ×¢× `ADMIN_EMAILS`
13. **`package.json`** - ×”×•×¡×¤×ª `npm run test:email`
14. **`README.md`** - ×§×™×©×•×¨×™× ×œ××¢×¨×›×ª ×”××‘×—×•×Ÿ

---

## ğŸš€ ××™×š ×œ×”×©×ª××©?

### ğŸ“ ×©×œ×‘ 1: ×‘×“×™×§×” ××§×•××™×ª

```bash
# ×•×•×“× ×©-.env ××•×’×“×¨ × ×›×•×Ÿ
npm run test:email
```

×”××¢×¨×›×ª ×ª×‘×“×•×§:
- âœ… ×§×¨×™××ª `.env`
- âœ… ×—×™×‘×•×¨ ×œ-SMTP
- âœ… ×©×œ×™×—×ª ××™×™×œ ×˜×¡×˜
- âœ… ×‘×“×™×§×ª ×˜×‘×œ×ª `email_logs`

### ğŸ“ ×©×œ×‘ 2: ×”×¢×œ××” ×œ×©×¨×ª

```bash
# ×‘× ×” ××ª ×”×¤×¨×•×™×§×˜
npm run build

# ×”×¢×œ×” ×œ×©×¨×ª (×“×¨×š FTP/GitHub Actions)
# ...

# ×‘×©×¨×ª (SSH):
pm2 restart fc-masters-cup
pm2 logs fc-masters-cup --lines 50
```

×—×¤×©: `âœ… SMTP verify OK`

### ğŸ“ ×©×œ×‘ 3: ×‘×“×™×§×” ×‘×©×¨×ª

```bash
# SSH ×œ×©×¨×ª
ssh user@k-rstudio.com

# ×”×¨×¥ ×¡×§×¨×™×¤×˜ ×‘×“×™×§×”
bash check-email-on-server.sh
```

### ğŸ“ ×©×œ×‘ 4: ×‘×“×™×§×” ××”×“×¤×“×¤×Ÿ

×›×× ×”×œ, ×’×© ×œ:
```
https://k-rstudio.com/api/admin/smtp/verify
https://k-rstudio.com/api/admin/smtp/email-logs
```

### ğŸ“ ×©×œ×‘ 5: ×‘×“×™×§×” ××¨×—×•×§ (PowerShell)

```powershell
.\test-email-remote.ps1
```

×”×¡×§×¨×™×¤×˜ ×™×‘×¦×¢:
- ×”×ª×—×‘×¨×•×ª ×›×× ×”×œ
- ×‘×“×™×§×ª SMTP verify
- ×©×œ×™×—×ª ××™×™×œ ×˜×¡×˜
- ×¦×¤×™×™×” ×‘×œ×•×’×™×

---

## ğŸ” ××™×š ×œ××‘×—×Ÿ ×‘×¢×™×•×ª?

### ×‘×¢×™×”: "SMTP verify FAILED"

**×¡×™××¤×˜×•××™×:**
```
âŒ SMTP verify FAILED { ... error: 'Invalid login' }
```

**×¤×ª×¨×•×Ÿ:**
1. ×•×“× ×©-`SMTP_PASS` ×”×•× **App Password** (16 ×ª×•×•×™×)
2. ×¦×•×¨ ×—×“×©: https://myaccount.google.com/apppasswords
3. ×•×•×“× ×©-2FA ××•×¤×¢×œ ×‘×—×©×‘×•×Ÿ
4. ×”×¤×¢×œ ××—×“×© ××ª ×”×©×¨×ª

### ×‘×¢×™×”: "Connection timeout"

**×¡×™××¤×˜×•××™×:**
```
âŒ SMTP verify FAILED { ... error: 'connect ETIMEDOUT' }
```

**×¤×ª×¨×•×Ÿ:**
1. ×¤×•×¨×˜ 587 ×—×¡×•× - ×‘×“×•×§:
   ```bash
   openssl s_client -starttls smtp -crlf -connect smtp.gmail.com:587 -quiet <<< "QUIT"
   ```
2. ×× × ×›×©×œ, × ×¡×” ×¤×•×¨×˜ 465:
   ```env
   SMTP_PORT=465
   SMTP_SECURE=true
   ```
3. ××• ×¦×•×¨ ×§×©×¨ ×¢× ×”×¡×¤×§ (Hostinger)

### ×‘×¢×™×”: × ×©×œ×— (SENT) ××‘×œ ×œ× ××’×™×¢

**×¡×™××¤×˜×•××™×:**
```
âœ… SMTP verify OK
status=SENT in email_logs
××‘×œ ××™×™×œ ×œ× ××’×™×¢
```

**×¤×ª×¨×•×Ÿ:**
1. ×‘×“×•×§ **SPAM/Promotions**
2. Google Account â†’ Security â†’ Recent activity
3. ××©×¨ "Blocked sign-in attempt" ×× ×™×©
4. ×‘×“×•×§ Rate Limit (500/×™×•×)
5. ×•×•×“× `EMAIL_FROM` = `SMTP_USER`

### ×‘×¢×™×”: "ADMIN_EMAILS is empty"

**×¡×™××¤×˜×•××™×:**
```
âš ï¸ ADMIN_EMAILS is empty â€“ no admin mails will be sent
```

**×¤×ª×¨×•×Ÿ:**
×”×•×¡×£ ×œ-`.env`:
```env
ADMIN_EMAILS=fcmasters9@gmail.com
```

××• ×× ×™×© ×›××”:
```env
ADMIN_EMAILS=fcmasters9@gmail.com,admin2@example.com
```

---

## ğŸ“Š ××‘× ×” ××¢×¨×›×ª ×”××‘×—×•×Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ×‘×¢×ª ×¢×œ×™×™×ª ×”×©×¨×ª                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. ××™××•×ª SMTP (verifySmtp)             â”‚   â”‚
â”‚  â”‚  2. ×”×¦×’×ª ×”×’×“×¨×•×ª (console.log)           â”‚   â”‚
â”‚  â”‚  3. ××–×”×¨×•×ª ×¢×œ ×”×’×“×¨×•×ª ×—×¡×¨×•×ª              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ×‘×¢×ª ×©×œ×™×—×ª ××™×™×œ                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. ×œ×•×’ ×¢×§×‘×•×ª (console.log)             â”‚   â”‚
â”‚  â”‚  2. sendMailSafe() â†’ nodemailer          â”‚   â”‚
â”‚  â”‚  3. ×¨×™×©×•× ×‘-email_logs (DB)             â”‚   â”‚
â”‚  â”‚  4. ×”×—×–×¨×ª ×ª×•×¦××” (success/error)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ×¦×¤×™×™×” ×‘×œ×•×’×™× (Admin)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  GET /api/admin/smtp/verify              â”‚   â”‚
â”‚  â”‚  POST /api/admin/smtp/test               â”‚   â”‚
â”‚  â”‚  GET /api/admin/smtp/email-logs          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… ×¡×™×›×•×

### ××” ×¢×©×™× ×•:
âœ… ××™××•×ª SMTP ××•×˜×•××˜×™ ×‘×¢×ª ×¢×œ×™×™×”  
âœ… ×œ×•×’ ××œ× ×©×œ ×›×œ ××™×™×œ ×‘-DB  
âœ… ××–×”×¨×•×ª ×¢×œ ×”×’×“×¨×•×ª ×—×¡×¨×•×ª  
âœ… 3 endpoints ×—×“×©×™× ×œ××‘×—×•×Ÿ  
âœ… ×œ×•×’×™× ××¤×•×¨×˜×™× ×‘× ×§×•×“×•×ª ×§×¨×™×˜×™×•×ª  
âœ… 3 ×¡×§×¨×™×¤×˜×™× ×œ×‘×“×™×§×” (××§×•××™/×©×¨×ª/××¨×—×•×§)  
âœ… 3 ××“×¨×™×›×™× ××¤×•×¨×˜×™×  
âœ… ×¢×“×›×•×Ÿ `.env.example`  

### ××” ×××•×¨ ×œ×¢×‘×•×“ ×¢×›×©×™×•:
âœ… ×¨××™×™×ª "âœ… SMTP verify OK" ×‘×¢×ª ×¢×œ×™×™×”  
âœ… ×©×œ×™×—×ª ××™×™×œ×™× ×œ×× ×”×œ×™× ×‘×”×¨×©××”  
âœ… ×©×œ×™×—×ª ××™×™×œ×™× ×œ×× ×”×œ×™× ×‘×”×¦×˜×¨×¤×•×ª ×œ×˜×•×¨× ×™×¨  
âœ… ×¨×™×©×•× ×›×œ ××™×™×œ ×‘-`email_logs`  
âœ… ×¦×¤×™×™×” ×‘×œ×•×’×™× ×“×¨×š API  
âœ… ×©×œ×™×—×ª ××™×™×œ ×˜×¡×˜ ×™×“× ×™×ª  

### ×¦×¢×“×™× ×”×‘××™×:
1. âœ… ×”×¨×¥ `npm run test:email` ××§×•××™×ª
2. âœ… ×ª×§×Ÿ ×©×’×™××•×ª (×× ×™×©)
3. âœ… `npm run build`
4. âœ… ×”×¢×œ×” ×œ×©×¨×ª
5. âœ… ×‘×“×•×§: `pm2 logs fc-masters-cup | grep SMTP`
6. âœ… ×‘×¦×¢ ×”×¨×©××” + ×”×¦×˜×¨×¤×•×ª ×œ×˜×•×¨× ×™×¨
7. âœ… ×•×•×“× ×©××™×™×œ×™× ××’×™×¢×™× ×œ-fcmasters9@gmail.com

---

## ğŸ“š ×§×™×©×•×¨×™× ×—×©×•×‘×™×

- **××“×¨×™×š ××¤×•×¨×˜**: [EMAIL-DIAGNOSTICS-GUIDE.md](EMAIL-DIAGNOSTICS-GUIDE.md)
- **×¡×™×›×•× ××”×™×¨**: [EMAIL-DIAGNOSTICS-SUMMARY.md](EMAIL-DIAGNOSTICS-SUMMARY.md)
- **×“×•×’××ª .env**: [env.example](env.example)

---

**× ×•×¦×¨ ×‘-21 ××•×§×˜×•×‘×¨ 2025** ğŸš€

