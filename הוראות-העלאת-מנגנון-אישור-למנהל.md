<div dir="rtl" style="text-align: right;">

# 🚀 מדריך: העלאת מנגנון אישור משתמשים לאתר החי

**מנהל:** roizohar111@gmail.com  
**תאריך:** 18 אוקטובר 2025  
**זמן משוער:** 15-20 דקות

---

## 📋 מה אנחנו עושים?

אנחנו מעלים עדכון לאתר החי שיוסיף:
- ✅ אישור מנהל למשתמשים חדשים
- ✅ שליחת מייל למנהל כשמשתמש חדש נרשם
- ✅ אפשרות לאשר/לדחות משתמשים ממייל או מהפאנל

---

## שלב 1: הכנת הקוד המעודכן במחשב שלך

### 1.1 וודא שהקוד מקומפל

פתח PowerShell בתיקיית הפרויקט (`C:\FC Masters Cup`):

```powershell
# קומפל את השרת
cd server
npm run build

# קומפל את הלקוח
cd ..\client
npm run build

# חזור לתיקייה הראשית
cd ..
```

זה ייצר:
- `server/dist/` - הקוד המקומפל של השרת
- `client/dist/` - הקוד המקומפל של הלקוח

### 1.2 בדוק שיש את הקבצים החדשים

```powershell
# בדוק שיש את הקבצים של מנגנון האישור
dir server\dist\routes\adminUsers.js
dir server\dist\routes\approvalRequests.js
```

אם הקבצים לא קיימים - הרץ שוב `npm run build`.

---

## שלב 2: עדכון קובץ .env לפרודקשן

### 2.1 פתח את הקובץ

פתח את הקובץ: `C:\FC Masters Cup\deploy-env-production.txt`

### 2.2 עדכן את ה-URLs

**חשוב מאוד!** שנה את השורות הבאות לדומיין האמיתי שלך:

```env
# במקום:
SITE_URL=https://fcmasters.yourdomain.com
CORS_ORIGIN=https://fcmasters.yourdomain.com

# שים את הדומיין האמיתי שלך, למשל:
SITE_URL=https://fcmasters.co.il
CORS_ORIGIN=https://fcmasters.co.il
```

**וודא שהשורות הבאות נכונות:**
```env
ADMIN_EMAIL=roizohar111@gmail.com
SMTP_USER=roizohar111@gmail.com
SMTP_PASS=acccxggzncimlcnr
```

### 2.3 שמור את הקובץ כ-.env

**אופציה 1: שנה את שם הקובץ**
```powershell
# מחק .env קיים אם יש
del .env

# שנה שם
ren deploy-env-production.txt .env
```

**אופציה 2: העתק את התוכן**
- פתח את `deploy-env-production.txt`
- העתק הכל
- צור קובץ חדש `.env`
- הדבק את התוכן
- שמור

---

## שלב 3: התחבר לשרת החי

### 3.1 פתח WinSCP

1. **Host name:** ה-IP של השרת שלך (או הדומיין)
2. **User name:** `root` או `fcmaster`
3. **Password:** הסיסמה שלך
4. לחץ **"Login"**

### 3.2 נווט לתיקיית האתר

בצד ימין (השרת), נווט ל:
```
/var/www/fcmasters
```

---

## שלב 4: גיבוי הקוד הישן (חובה!)

### 4.1 יצירת גיבוי

בצד ימין (השרת), לחץ לחצן ימני על התיקייה `server` → **Duplicate**

שנה את השם ל:
```
server-backup-2025-10-18
```

**חשוב:** וודא שיש גיבוי לפני שאתה ממשיך!

---

## שלב 5: העלאת הקוד המעודכן

### 5.1 העלה את הקבצים הבאים

**בלחיצה ימנית על כל תיקייה/קובץ, בחר "Upload and Overwrite":**

#### קבצי שרת (צד שמאל → צד ימין):

1. **העלה תיקייה:**
   ```
   C:\FC Masters Cup\server\dist\
   → /var/www/fcmasters/server/dist/
   ```
   
2. **העלה קובץ .env:**
   ```
   C:\FC Masters Cup\.env
   → /var/www/fcmasters/.env
   ```

3. **העלה את client/dist (אם עדכנת משהו בצד הלקוח):**
   ```
   C:\FC Masters Cup\client\dist\
   → /var/www/fcmasters/client/dist/
   ```

**זמן משוער:** 2-3 דקות

### 5.2 בדוק שהקבצים הועלו

בצד ימין, נווט ל:
```
/var/www/fcmasters/server/dist/routes/
```

וודא שרואה:
- ✅ `adminUsers.js` (קובץ חדש!)
- ✅ `approvalRequests.js` (קובץ חדש!)
- ✅ `auth.js` (מעודכן)
- ✅ `admin.js` (מעודכן)

---

## שלב 6: אתחול השרת

### 6.1 פתח PuTTY

1. **Host Name:** ה-IP או הדומיין שלך
2. **Port:** 22
3. לחץ **"Open"**
4. התחבר: `root` או `fcmaster`

### 6.2 אתחל את השרת

```bash
# עבור לתיקיית האתר
cd /var/www/fcmasters

# אתחל את PM2
pm2 restart fc-masters

# ראה שהשרת רץ
pm2 status
```

אתה צריך לראות:
```
┌─────┬──────────────┬─────────┬─────────┐
│ id  │ name         │ status  │ restart │
├─────┼──────────────┼─────────┼─────────┤
│ 0   │ fc-masters   │ online  │ 1       │
└─────┴──────────────┴─────────┴─────────┘
```

### 6.3 בדוק שאין שגיאות

```bash
pm2 logs fc-masters --lines 30
```

חפש את ההודעות:
```
✅ Added approvalStatus column to users table
✅ Added approvalToken column to users table
✅ Server started successfully on http://localhost:8787
```

אם רואה את זה - **מעולה!** 🎉

---

## שלב 7: בדיקות

### 7.1 בדוק שהאתר עובד

פתח דפדפן וגש לאתר שלך:
```
https://fcmasters.co.il
```

(החלף בדומיין האמיתי שלך)

האתר צריך לעבוד כרגיל.

### 7.2 בדוק התחברות מנהל

1. לחץ על **"התחבר"**
2. התחבר עם:
   - Email: `roizohar111@gmail.com`
   - Password: `Roizohar1985`

צריך להיכנס ללא בעיה.

### 7.3 בדוק רישום משתמש חדש

#### א. נסה להירשם

1. פתח חלון פרטי/incognito בדפדפן
2. גש לאתר
3. לחץ **"הרשמה"**
4. הירשם עם משתמש דמה:
   - Email: `test@example.com`
   - Password: `Test1234`
   - PSN Username: `TestPlayer`
5. לחץ **"הרשם"**

#### ב. בדוק את ההודעה

אתה צריך לראות הודעה:
```
ההרשמה התקבלה בהצלחה! 
תקבל מייל ברגע שהמנהל יאשר את חשבונך.
```

#### ג. בדוק שהמשתמש לא יכול להתחבר

1. נסה להתחבר עם `test@example.com` / `Test1234`
2. צריך לקבל שגיאה:
   ```
   החשבון שלך ממתין לאישור המנהל. 
   תקבל מייל ברגע שהחשבון יאושר.
   ```

**אם זה עובד - מעולה!** ✅

### 7.4 בדוק שהמייל נשלח למנהל

1. פתח את המייל: `roizohar111@gmail.com`
2. חפש מייל מ-`FC Masters Cup`
3. הנושא: `משתמש חדש ממתין לאישור! 👤⏳`

**אם המייל לא הגיע** - בדוק spam/junk.

**אם עדיין לא הגיע** - ראה את "פתרון בעיות" למטה.

### 7.5 בדוק אישור משתמש

#### במייל:
1. פתח את המייל שקיבלת
2. לחץ על כפתור **"✅ אשר משתמש"**
3. אמור להיפתח דף שאומר: `המשתמש אושר בהצלחה!`

#### בפאנל הניהול:
1. התחבר כמנהל
2. לחץ על **"פאנל ניהול"**
3. חפש את המשתמש `test@example.com`
4. אמור להיות כפתור **"אשר"** או **"דחה"**

### 7.6 בדוק שהמשתמש קיבל מייל

1. המשתמש `test@example.com` אמור לקבל מייל:
   - נושא: `החשבון שלך אושר! ברוכים הבאים ל-FC Masters Cup! 🎉⚽`
2. עכשיו המשתמש יכול להתחבר!

---

## 🎉 סיימת!

### ✅ מה יש לך עכשיו:

- ✅ מנגנון אישור משתמשים פעיל
- ✅ מייל למנהל כשמשתמש חדש נרשם
- ✅ מייל למשתמש כשהוא ממתין לאישור
- ✅ מייל למשתמש כשהוא מאושר
- ✅ לחצני אישור/דחייה במייל
- ✅ אישור/דחייה מפאנל הניהול

---

## 🆘 פתרון בעיות

### בעיה: המיילים לא נשלחים

#### פתרון 1: בדוק את הלוגים

```bash
# בשרת (PuTTY)
pm2 logs fc-masters --lines 50
```

חפש שורות כמו:
```
[email] ✅ Admin approval request sent to: roizohar111@gmail.com
```

אם רואה:
```
[email] ❌ Failed to send admin approval request
```

המייל לא נשלח.

#### פתרון 2: בדוק את הגדרות SMTP

```bash
# בדוק את .env
cat /var/www/fcmasters/.env | grep SMTP
```

וודא שרואה:
```
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=roizohar111@gmail.com
SMTP_PASS=acccxggzncimlcnr
SMTP_SECURE=false
```

#### פתרון 3: בדוק שהסיסמת App Password תקינה

1. היכנס ל: https://myaccount.google.com/apppasswords
2. בדוק שהסיסמה `acccxggzncimlcnr` עדיין פעילה
3. אם לא - צור סיסמה חדשה ועדכן ב-.env

#### פתרון 4: אתחל שוב

```bash
pm2 restart fc-masters
```

---

### בעיה: האתר לא עובד אחרי העדכון

#### פתרון: שחזר מגיבוי

```bash
# עצור את השרת
pm2 stop fc-masters

# מחק את התיקייה המעודכנת
cd /var/www/fcmasters
rm -rf server/dist

# שחזר מהגיבוי
cp -r server-backup-2025-10-18/dist server/

# הפעל שוב
pm2 restart fc-masters
```

---

### בעיה: שגיאת "approvalStatus column"

זה אומר שהטבלה לא עודכנה. תקן ידנית:

```bash
# בשרת
cd /var/www/fcmasters/server

# הרץ Node.js
node -e "
const db = require('better-sqlite3')('tournaments.sqlite');
db.exec('ALTER TABLE users ADD COLUMN approvalStatus TEXT NOT NULL DEFAULT \"approved\"');
db.exec('ALTER TABLE users ADD COLUMN approvalToken TEXT');
console.log('✅ Columns added');
"
```

---

## 📞 צריך עזרה?

אם משהו לא עובד:

1. **בדוק לוגים:**
   ```bash
   pm2 logs fc-masters --lines 100
   ```

2. **בדוק שהקבצים הועלו:**
   ```bash
   ls -la /var/www/fcmasters/server/dist/routes/
   ```

3. **בדוק שה-.env נכון:**
   ```bash
   cat /var/www/fcmasters/.env
   ```

4. **אתחל הכל:**
   ```bash
   pm2 restart fc-masters
   sudo systemctl reload nginx
   ```

---

## 🔄 אם רוצה לבטל את השינויים

```bash
# עצור שרת
pm2 stop fc-masters

# מחק dist חדש
rm -rf /var/www/fcmasters/server/dist

# שחזר מגיבוי
cp -r /var/www/fcmasters/server-backup-2025-10-18/dist /var/www/fcmasters/server/

# הפעל שוב
pm2 restart fc-masters
```

---

## 📝 סיכום זמנים

| שלב | זמן |
|-----|-----|
| הכנת קוד | 2 דקות |
| עדכון .env | 2 דקות |
| גיבוי | 1 דקה |
| העלאת קבצים | 3 דקות |
| אתחול שרת | 1 דקה |
| בדיקות | 5 דקות |
| **סה"כ** | **15 דקות** |

---

**בהצלחה! 🚀**

שאלות? אני כאן לעזור! 💪

</div>

